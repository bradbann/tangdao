<%
var modelAttr = pageCtx("modelAttr");
var p = {

	// 标签参数
	id: id!,					// 元素ID
	
	path: path!,				// 绑定form上model中属性的值
	name: name!,				// 隐藏域名称
	value: value!,				// 隐藏域值
	
	labelPath: labelPath!,		// 绑定form上model中属性的值
	labelName: labelName!,		// 标签框名称
	labelValue: labelValue!,	// 标签框值
	
	class: class!'',			// 标签框的CSS类名
	placeholder: placeholder!'请选择',	// 标签框的预期值的提示信息
	//dataMsgRequired: thisTag.attrs['data-msg-required'],	// 必填错误提示信息
	
	//btnClass: btnClass!,		// 标签框后面的按钮CSS类名
	
	title: title!'选项选择',		// 对话框标题
	boxWidth: boxWidth!300, 	// 对话框宽度，默认300像素
	boxHeight: boxHeight!400,	// 对话框高度，默认400像素
	
	url: url!,					// 树结构，数据源地址 [{id, pid, name}]
	
	readonly: @ObjectUtils.toBoolean(readonly!false),		// 是否只读模式
	
	allowInput: @ObjectUtils.toBoolean(allowInput!false),	// 是否允许label框输入
	allowClear: @ObjectUtils.toBoolean(allowClear!true),	// 是否允许清空选择内容
	
	checkbox: @ObjectUtils.toBoolean(checkbox!false),		// 是否显示复选框，是否支持多选，如果设置canSelectParent=true则返回父节点数据
	expandLevel: @ObjectUtils.toInteger(expandLevel!(-1)),		// 默认展开层次级别（默认:如果有1个根节点，则展开一级节点，否则不展开）
	
	canSelectRoot: @ObjectUtils.toBoolean(canSelectRoot!false),		// 可以选择跟节点
	canSelectParent: @ObjectUtils.toBoolean(canSelectParent!false),	// 可以选择父级节点
	
	isReturnValue: isReturnValue!'false',		// 是否返回树结构的value值，而不是返回id（默认id）
	
	returnFullName: @ObjectUtils.toBoolean(returnFullName!false),	// 是否返回全路径，包含所有上级信息，以 returnFullNameSplit 参数分隔
	returnFullNameSplit: returnFullNameSplit!'/'					// 是否返回全路径，的分隔符，默认“/”
	
};

var id = id!name!p.path;
var name = name!p.path;
var value = p.value!;
if(isEmpty(value!)&&isNotEmpty(p.path!)){
	value = modelAttr[p.path];
}
if(isEmpty(value!)){
	value = p.defaultValue;
}
if(isNotEmpty(p.dataFormat)){
	if("number"==p.dataFormat){
		value = parseDouble(value);
	}else{
		value = date(value, p.dataFormat);
	}
}
%>

<div class="layui-input-group" id="${id}Div" 
data-url="${url}"
>
                  <input id="${id}Name" type="text" name="${p.labelName}"  value="${p.labelValue}" class="layui-input" placeholder="${p.placeholder}" />
                  <input id="${id}Id" type="hidden" name="${name}" value="${p.value}"/>
                  <span class="layui-input-group-btn">
                  <a id="${id}Button" href="javascript:"
class="layui-btn"><i class="layui-icon layui-icon-senior"></i></a>
                  </span>
                  </div>
<script>
$("#${id}Button,#${id}Name").click(function(){
	if ($("#${id}Button").hasClass("disabled")){
		return true;
	}
	var options = {
		type: 2,
		maxmin: true,
		shadeClose: true,
		skin: 'layui-layer-admin',
		title: '${p.title}',
		area: ['${p.boxWidth}px', '${p.boxHeight}px'],
		content: '${ctxPath}/tags/treeselect',
		contentFormData: {
			url: $('#${id}Div').attr('data-url'),
			checkbox: '${p.checkbox}',
			expandLevel: '${p.expandLevel}',
			selectIds: $("#${id}Id").val(),
			isReturnValue: '${p.isReturnValue}'
		},
		success: function(layero, index){
			if ($(layui.layer.window).width() < 300
				|| $(layui.layer.window).height() < 400){
				layui.layer.full(index);
			}
		},
		btn: ['<i class="fa fa-check"></i> 确定'],
		btn1: function(index, layero){
			//console.log(index);
			//console.log(layero);
			var win = null;
			var b = $(layero).find("iframe");
	        if (b.length > 0) {
	        	win = b[0].contentWindow;
	        }
	        //console.log(win);
			
			//var win = layero.iframeWindow();
			win.$('#keyword').val('').change(); 	
			var codes = [], names = [], nodes;
			if ("${p.checkbox}" == "true"){
				nodes = win.tree.getCheckedNodes(true);
			}else{
				nodes = win.tree.getSelectedNodes();
			}
			for(var i=0; i<nodes.length; i++) {
				var code = nodes[i]['false'=='true'?'value':'id'], name = nodes[i]['name'];
				codes.push(code.replace(/^u_/g,''));
				names.push(name.replace(/\([0-9]*\)/g,''));
				break;
			}
			if(typeof treeselectCheck == 'function'){
				if (!treeselectCheck('${id}', nodes)){
					return false;
				}
			}
			$("#${id}Id").val(codes.join(',')).change();
			$("#${id}Name").val(names.join(',')).change();
			try { $('#${id}Id,#${id}Name').valid(); }catch(e){}
			if(typeof treeselectCallback == 'function'){
				treeselectCallback('${id}', 'ok', index, layero, nodes);
			}
		}
	};
	<%if(p.allowClear){%>
	options.btn.push('<i class="fa fa-eraser"></i> 清除');
	options['btn'+options.btn.length] = function(index, layero){
		$("#${id}Id").val('').change();
		$("#${id}Name").val('').change();
		if(typeof treeselectCallback == 'function'){
			treeselectCallback('${id}', 'clear', index, layero);
		}
	};
	<%}%>
	options.btn.push('<i class="fa fa-close"></i> 关闭');
	options['btn'+options.btn.length] = function(index, layero){
		if(typeof treeselectCallback == 'function'){
			treeselectCallback('${id}', 'cancel', index, layero);
		}
	};
	top.layui.admin.open(options);
});
</script>